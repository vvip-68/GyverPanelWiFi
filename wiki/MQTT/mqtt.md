Для управления устройством может использоваться канал связи с использованием технологии MQTT (Message Queue Telemetry Transport).
В интернете можно найти множество статей, объясняющих принципы функционирования протокола, дающие понятия о подписках, публикациях и другие основные сведения.

Список публичных MQTT-серверов можно найти [здесь](https://github.com/mqtt/mqtt.github.io/wiki/public_brokers)  
Один из обзоров публичных MQTT серверов можно изучить на [этой](https://kotyara12.ru/pubs/iot/cloud_services/) странице.  

Как правило, сервера отличаются наличием наряду с платными, бесплатных сервисов, которые, однако, имеют ограничение на количество одновременных подключений к брокеру,
количество разрешенных запросов в период времени, наличие / отсутствие авторизации при подключении, поддержкy SSL и так далее.
Выберите подходящий именно вам MQTT брокер, изучите документацию на него, настройте подключение.  

В этой статье дана инструкция по настройке MQTT соединения для управления устройством на примере российского бесплатного MQTT-брокера [mqtt.4api.ru](https://mqtt.4api.ru/).

## Настройка сервера
Зарегистрируйтесь на сервере. Сервер предлагает вариант регистрации на основе одной из социальных сетей.
Выберите подходящую вам социальную сеть и нажмите на ее значок внизу окна регистрации.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-01.png)  

Если сеть запросит разрешение на использование аккаунта - подвердите, что вы согласны и осознаете свои действия.  
Когда согласие будет получено, вы увидете страницу вашего личного кабинета на MQTT-сервере.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-02.png)  

Вам предлагается на выбор два варианта MQTT-брокера - **[SRV.1]** и **[SRV.2]**. 
Для наших целей нет разницы, какой из серверов использовать. Их отличие - **[SRV.2]** поддерживает SSL соединение и
требует предварительной регистрации списка устройств, от которых будут приниматься сообщения.  

SSL в нашей прошивке не используется (кому нужно - тот настроит), а вот ограничение списка подключаемых устройств
может послужить дополнительной защитой от "несанкционированного доступа". Впрочем, решать вам.

Я предлагаю использовать брокер **[SRV.2]**. 
Для просмотра параметров подключения к брокеру, перейдите по ссылке "Профиль" раздела **СЕРВЕР [SRV.2]**  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-03.png)  

Открывшаяся страница содержит сведения о параметрах подключения, ожидаемых брокером.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-06.png)  

Прежде всего, нас интересуют следующие поля:
1. Сервер - имя сервера, к которому будет выполняться подключение для создания MQTT-канала управления
2. Протокол|Порт - порт подключения **устройства**
3. Протокол|Порт - порт подключения **браузерной панели управления**
4. Пользователь - имя пользователя для подключения к серверу
5. Пароль - пароль для подключения к серверу

Пароль скрыт и не отображается. Нажмите надпись **"Запросить новый"**. Пароль отобразится вместо текста "Пароль скрыт"  
Запишите этот пароль. Здесь вы его можете увидеть лишь один раз. При каждом повторном нажатии на *"Запросить новый"* будет генерироваться новый пароль и вам придется
менять соответствующие настройки в прошивке.

Этих сведений достаточно для настройки соединения в скетче.  
Откройте в Arduino IDE файл прошивки **"a_def_soft.h"**. Найтите строки 269-283.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-08.png)  

Перенесите значения соответствующих настроек из окна "Профиль" настроек подключения в скетч  

- DEFAULT_MQTT_SERVER "srv2.clusterfly.ru" // MQTT сервер
- DEFAULT_MQTT_USER "user_af7cd12a"        // Имя mqtt-пользователя    (укажите имя пользователя для вашего соединения)
- DEFAULT_MQTT_PASS "pass_eb250bf5"        // Пароль mqtt-пользователя (укажите пароль вашего соединения)
- DEFAULT_MQTT_PORT 9991                   // Порт mqtt-соединения

Строки 278-283 содержат недействительные учетные данные для примера.  
Обратите внимание на строку 269. Она закомментирована.  
Это оначает, что ваши настройки с чувствительными данными хранятся в отдельном файле с именем **"a_def_pass.h"**, который не включен в состав исходников.
Вам нужно будет создать этот файл и перенести в него строки 278-283 с вашими персональными учетными данными или же просто раскомментировать строку 269. 
Тогда все настройки можно задавать непосредственно в строках 278-283.

Следующим шагом нужно создать на сервере список идентификаторов устройств (клиентов) от которых брокеру разрешено принимать сообщения.
Устройство с идентификатором, отсутствующим в списке, не сможет установить подключение к MQTT-серверу.

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-09.png)  

Строка 294 содержит общий идентификатор класса устройств этого проекта - все устройства это устройства - **"WiFiPanel"**. Конкретный экземпляр устройства задается
значением DEVICE_ID, объявленным в файле **"a_def_hard.h"** в строке 14. В моем проекте здесь просто указан список работающих у меня устройств и определяется конкретный
номер для задания условий компиляции. Ниже в этом файле директивы условной компиляции задают набор параметров прошивки для каждого конкретного устройства - пины подключения,
наличие тех или иных компонентов, точка подключения и направление из угла матрицы, размеры самой матрицы и т.п. Поскольку DEVICE_ID в данном случае однозначно 
характеризует и идентифицирует устройство - он и используется для создания идентификатора устройства на сервере MQTT.  

Итак, идентификатор клиента в этом примере - "WiFiPanel-0", и создается по правилу: MQTT_CLIENT_ID + "-" + DEVICE_ID  

Пришла пора зарегистрировать устройства на сервере. Откройте страницу по ссылке "Мои устройства"  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-04.png)  

Здесь нам необходимо добавить все нужные устройства в список устройств, знакомых серверу.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-07.png)  

Введите в поле идентификатор клиента (в нашем случае WiFiPanel-0) и нажмите кнопку "Добавить". Теперь сервер знает, что к нему может подключаться 
наше собранное на ESP8266 устройство.  

Для управления по каналу MQTT требуется как минимум 2 участника - наше устройство и некоторый менеджер, который будет отправлять управляющие команды.
Это может быть соответствующая программа на телефоне или же панель консоли MQTT-брокера, например [эта](http://client.mqtt.4api.ru/). 
Для неё также нужно зарегистрировать идентификатор в списке известных брокеру устройств.  

Введите в поле идентификатор (например "Manager", "Admin" или "Phone" - как вам нравится) и нажмите кнопку "Добавить". 
Теперь брокер знает обо всех наших устройствах.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-11.png)  

Итак, параметры соединения определены, прошивку можно загружать в устройство.  
После того как прошивка загружена и стартовала, в мониторе порта будет виден лог подключения.  
Если все прошло успешно, вы увидите примерно следующее:  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-16.png)  

Проверить установку соединения можно в разделе "Web-client" личного кабинета. Нажмите на указанную ссылку  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-05.png)  

На странице Web-клиента укажите свой пароль полученный ранее, в поле ClientID - идентификатор клиента, созданный на предыдущем шаге настройки.
В нашем случае - это "Manager". Нажмите кнопку "Подключиться".  

В поле "Топик" введите "WiFiPanel-0/cmd", в поле команды - какую-нибудь подходящую команду из [API управления устройством](https://github.com/vvip-68/GyverPanelWiFi/wiki/API-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE%D0%BC).
Нажмите кнопку "Отправить". Если все сделано правильно, в мониторе порта вы увидите запись о входящей команде и результат ее выполнения в логе и на матрице.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-12.png)  

Тем не менее данный Web-client ограничен в своих возможностях и мало на что годится. 
Для управления устройством и наблюдения за его функционированием удобнее использовать более специализированную консоль, например [эту](http://client.mqtt.4api.ru/).  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-15.png)  

Заполните поля, необходимые для подключения к нашему MQTT-брокеру.  
- В поле "Host" - имя MQTT-сервера из настроек - "srv2.clusterfly.ru"  
- В поле "Port" - номер порта Websocket - 9993  
- В поле "Client ID" - идентификатор клиента управляющей панели - "Manager"  
- В поле "Username" - имя вашего пользователя для подключения к брокеру (в нашем примере - "user_af7cd12a")  
- В поле "Password" - пароль из настроек выше (в нашем примере - "pass_eb250bf5")  
- Нажмите кнопку "Подключить"  

Если все идентификационные данные введены верно и сервер доступен, панель параметров подключения свернется, индикатор станет зеленого цвета - connected.  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-10.png)  

Следующий шаг - регистрация топиков, которые брокер ожидает от устройства. Нажмите кнопку "Add New Topic Suscription". 
В открывшейся панели введите название топика, выберите цвет пометки сообщений и нажмите кнопку "Subscribe"  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-14.png)  

Используемый нами брокер ожидает топик подписки, сформированный по следующему правилу:  
MQTT_USER + "/" + MQTT_CLIENT_ID + "-" - DEVICE_ID + "/" + TOPIC_XXX  
что в нашем случае означает *user_af7cd12a/WiFiPanel-0/#*  

В соответствии справилами подписки, знак '#' означает - все "топики" ниже уровня *user_af7cd12a/WiFiPanel-0*  
Наша прошивка использует следующие значения третьего уровня:
- cmd - топик команд управления
- dta - топик данных, получаемых в программу от прошивки (например - текущие значения параметров прошивки)
- nfo - топик уведомлений от прошивки (переключился режим, синхронизировалось время / погода, сработал будильник и т.д.)
- err - топик сообщений об ошибках (неверные параметры команды, нераспознанная команда и т.д.)
- ack - топик уведомлений, что команда принята и обработана, никаких данных в ответ не ожидается

При желании можно оформить отдельную подписку на каждый из топиков и задать им соответствующие цвета пометки сообщений.
В этом случае результат коммуникации панели управления с устройством может выглядеть примерно так  

![Fast Patch](https://github.com/vvip-68/GyverPanelWiFi/blob/master/wiki/MQTT/mqtt-13.png)  

В разделе **Publish** панели управления, в поле "Topic" вы можете указать топик для отправки команд - *user_af7cd12a/WiFiPanel-0/cmd*,
затем в поле "Message" - какую-нибудь подходящую команду из [API управления устройством](https://github.com/vvip-68/GyverPanelWiFi/wiki/API-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE%D0%BC)
и отправить её, нажав кнопку "Publish". Реакцию устройства на команду можно видеть в мониторе порта и в секции "Messages" панели управления  

На этом настройка устройства для управления по каналу MQTT завершена.  
В настоящее время нет специальной программы для управления устройством через MQTT, хотя планы на ее создание есть.  
Если у вас есть соответствующие знания - вы можете настроить управление устройством через голосовые помощники, например - Яндекс Алиса или Google Assistant.




